server {
    listen 443 ssl;  # remove deprecated 'http2' in listen
    server_name monitoring.coldemailgenrator.online;

    ssl_certificate /etc/letsencrypt/live/coldemailgenrator.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/coldemailgenrator.online/privkey.pem;

    ##
    ## TRUSTED PROXIES (allow X-Forwarded-For)
    ##
    set_real_ip_from 127.0.0.1;        # localhost
    set_real_ip_from 172.16.100.0/27;  # VPN subnet
    set_real_ip_from 172.17.0.0/16;    # Docker bridge
    # add any other internal proxy/public IP ranges here

    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    ##
    ## ACCESS CONTROL
    ##
    allow 172.16.100.0/27;
    allow 172.17.0.0/16;   # optional, internal Docker
    deny all;

    ##
    ## PROMETHEUS
    ##
    location /monitoring/prometheus/ {
        proxy_pass http://prometheus:9090;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Prefix /monitoring/prometheus;
        proxy_redirect off;
    }

    ##
    ## GRAFANA
    ##
    location /monitoring/grafana/ {
        proxy_pass http://grafana:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Prefix /monitoring/grafana;
        proxy_redirect off;
    }

    ##
    ## OPTIONAL: Debug Logging for IPs
    ##
    log_format vpn_full_ips '$remote_addr - $http_x_forwarded_for [$time_local] "$request" $status';
    access_log /var/log/nginx/vpn_access.log vpn_full_ips;
}
