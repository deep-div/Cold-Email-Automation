# # =================================================
# #              Enterprise CI/CD Pipeline
# # =================================================
name: Enterprise CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
#   # ========================
#   # Build & Lint & Security
#   # ========================
#   build:
#     name: Build, Lint & Security
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       # Install dependencies
#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#           pip install pytest bandit

#       # # Lint / static analysis
#       # - name: Lint code
#       #   run: |
#       #     pip install flake8
#       #     flake8 .

#       # Security scan - Static Analysis
#       - name: Bandit Security Scan
#         run: |
#           bandit -r . -ll

#       # # Security scan - Secret scanning
#       # - name: Secret Scan with Gitleaks
#       #   uses: gitleaks/gitleaks-action@v2
#       #   with:
#       #     args: detect --source . --no-banner

#   # ========================
#   # Unit Tests
#   # ========================
#   test:
#     name: Unit Tests
#     runs-on: ubuntu-latest
#     needs: build

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#           pip install pytest

#       - name: Run pytest
#         run: |
#           python -m pytest tests/ --maxfail=1 --disable-warnings -q

#   # ========================
#   # Docker Build & Security
#   # ========================
#   docker:
#     name: Build Docker Image & Scan
#     runs-on: ubuntu-latest
#     needs: test

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Log in to Docker Hub
#         uses: docker/login-action@v2
#         with:
#           username: ${{ secrets.DOCKER_HUB_USERNAME }}
#           password: ${{ secrets.DOCKER_HUB_PASSWORD }}

#       # Build Docker image
#       - name: Build Docker image
#         run: docker compose -f docker/docker-compose.yml build

#       # Docker security scan
#       - name: Scan Docker image with Trivy
#         uses: aquasecurity/trivy-action@0.20.0
#         with:
#           image-ref: 'deepdiv/cold-email-app:latest'
#           severity: 'HIGH,CRITICAL'
#           ignore-unfixed: true

#       # Tag image with commit SHA
#       - name: Tag Docker image with SHA
#         run: docker tag deepdiv/cold-email-app:latest deepdiv/cold-email-app:${{ github.sha }}

#       # Smoke test
#       - name: Smoke Test - Container Starts Correctly
#         run: |
#           docker run -d --name smoke deepdiv/cold-email-app:${{ github.sha }}
#           sleep 5
#           docker logs smoke
#           docker ps -a | grep smoke
#           docker stop smoke
#           docker rm smoke

#       # Push Docker image to Hub
#       - name: Push Docker image
#         run: docker push deepdiv/cold-email-app:${{ github.sha }}

  # ========================
  # Deploy to Azure
  # ========================
  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    # needs: docker  # wait for Docker image build & push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.VM_PUBLIC_IP }}               # Azure VM public IP
          username: ${{ secrets.VM_USER }}           # e.g., azureuser
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}         # Private SSH key
          port: 22
          script: |
            docker stop cold-email-app || true
            docker rm cold-email-app || true
            docker pull deepdiv/cold-email-app:2e2c40241ea3c3ab7cbdf382d36d20637667bc70
            docker run -d --name cold-email-app -p 8501:8501 deepdiv/cold-email-app:2e2c40241ea3c3ab7cbdf382d36d20637667bc70

